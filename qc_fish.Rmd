---
title: "FishQAQC"
author: "Catarina Pien"
date: "7/29/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---
Originally from FishCode for WISKI database
Revised 8/5/2021 by C. Pien
Revised 9/1/2021 by C. Pien - added data requests
Revised 8/7/2021 by C. Pien
Revised 12/6/2021 by C. Pien - added new effort template
Revised 2/2/2022 by C. Pien
Revised 4/19/2022 by C. Pien-

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load libraries
```{r load }
library(tidyverse)
library(lubridate)
library(anytime)
library(stringr)
library(magrittr)
library(kableExtra)
library(viridis)
```
# Bring in data

##1. Import in data
```{r importdata}

# All retrieved 5/10/2022

# Read in catch from folder
filenames <- list.files("Data/Catch", pattern="*.csv", full.names=TRUE)
Catchread <- lapply(filenames, read.csv)
# Bind fish catch files together
fish_catch <- bind_rows(Catchread, .id = "column_label")
effort <- read.csv("Data/YBFMP_TrapHours_2010_2020.csv")
fish_stations <- read.csv("Data/YBFMP_Stations_Coordinates_info.csv")
fish_ref <- read.csv("Data/Sample_20220510.csv")
fish_tax <- read.csv("Data/FishLookUp.csv")
fish_tax_ed <- read.csv("Data/FishTaxonomyKISTERS.csv") #Edited for KISTERS, only has species present
smelt_gen <- read.csv("Data/SmeltGenetics_20220510.csv")
salm_gen <- read.csv("Data/SalmGenetics_20220510.csv")
seine <- read.csv("Data/SeineEffort_20220510.csv")
trap <- read.csv("Data/TrapEffort_20220510.csv")
cwt <- read.csv("Data/CWT_20220510.csv")
stationNum <- read.csv("Data/YBFMP_Stations_Coordinates_Info.csv")
str(fish_ref)
```

Make some lists
```{r}
dietOrgs <- c("CHN", "RBT", "WAG", "LFS", "DSM")
salmonids <- c("CHN", "RBT")
smelts <- c("DSM", "WAG", "LFS")
```

Functions
```{r}
## define a helper function
empty_as_na <- function(x){
    if("factor" %in% class(x)) x <- as.character(x) ## since ifelse wont work with factors
    ifelse(as.character(x)!="", x, NA)
}


rpdlag <- function(x) {
  rpd = x-lag(x,1)/((x+ lag(x,1)/2))
  return(rpd)
}
x <- AL_data$Secchi

rpdlead <- function(x) {
  rpd = lead(x)-x/((x + lead(x))/2)
  return(rpd)
} 
```

Plot stations
```{r}
fish_stations_only <- fish_stations %>% filter(grepl("FISH", Databases))
fish_stations_only$Monitoring.Type <- factor(fish_stations_only$Monitoring.Type)
unique(fish_stations_only$Monitoring.Type)

pal <- colorFactor(viridis(7), fish_stations_only$Monitoring.Type)

library(leaflet)
fish_stations_only %>%
  leaflet() %>%
  addTiles() %>%
  addCircleMarkers(
    color = ~pal(Monitoring.Type),
    radius = 3,
    stroke = TRUE, #circle outline
    fillOpacity = 0.8,
    lng = ~Longitude,
    lat = ~Latitude,
   label = ~paste(Station.Name, "Lat:", Latitude, "Long:", Longitude))%>%
  addLegend(pal = pal,
            values = ~Monitoring.Type,
            position = "bottomright")
```


#QA/QC

##2. Clean up each data table
- clean up categorical variable naming
- remove certain columns
- add columns

### Fish_ref (sampling)
```{r clean}
# Sample 
fish_ref_clean <- fish_ref %>% 
  select(-c(YSI.Handheld..,DataCorrectionComments, UserName:s_Lineage)) %>%
  filter(!StationCode %in% c("STB", "STB3", "STB5", "STFP", "YBSP1", "CCS5", "CCS6")) %>%
  mutate(StationCode = replace(StationCode, StationCode == "STS", "BL4"),
         StationCode = replace(StationCode, StationCode == "YBSP1", "YB")) %>%
  mutate(StationCode = replace(as.character(StationCode), StationCode == "LI", "LIS")) %>%
 mutate(MethodCode = replace(MethodCode, MethodCode == "FNET", "FKTR")) %>%
  mutate(Datetime = paste(SampleDate, SampleTime, sep = " "),
         Datetime = mdy_hms(Datetime),
         SampleDate = as.Date(SampleDate,format ="%m/%d/%Y"),
         SampleTime = parse_date_time(SampleTime, '%I:%M:%S %p')) %>%
  filter(MethodCode %in% c("FKTR", "BSEIN", "RSTR"),
         !is.na(SampleID)) %>%
  arrange(Datetime)

# fish_ref$Year <- ordered(year(fish_ref$Datetime))
# fish_ref$Month <- ordered(month(fish_ref$DateTime))

unique(fish_ref_clean$VegetationRank)
unique(fish_ref_clean$GearConditionCode)
unique(fish_ref_clean$StationCode)
unique(fish_ref_clean$MethodCode)
unique(fish_ref_clean$GearID)
```

### Station Number
```{r}
# Station Number
staNum_clean <- stationNum %>%
  select(c(1,2)) %>%
  rename(StationCode = Station.Name,
         StationNumber = Station.Number)
```

###Catch
```{r}
# Catch
fish_catch_clean <- fish_catch %>%
  select(-c(s_ColLineage:s_Lineage,  Direct.Take:Indirect.Take, column_label)) %>%
  mutate(OrganismCode = ifelse(as.character(OrganismCode) == "lp", "LP", as.character(OrganismCode)),
         OrganismCode = ifelse(as.character(OrganismCode) == "tfs", "TFS", as.character(OrganismCode)),
  OrganismCode = ifelse(as.character(OrganismCode) == "SF", "PKN", as.character(OrganismCode))) %>%
  rename(FishIDComments = Comments,
         PlusCount = Plus.Count, 
         SpawningCondition = Spawning.Condition,
         GeneticSample = Genetic.Sample,
         RaceByLength = Race) %>%
  mutate(RaceByLength = 
        ifelse(RaceByLength %in% c("f", "F"), "Fall",
        ifelse(RaceByLength == "S", "Spring",
        ifelse(RaceByLength == "LF", "LateFall",
        ifelse(RaceByLength == "W", "Winter",                     ifelse((RaceByLength == "U" | RaceByLength == "" | RaceByLength == "n/p"), NA, as.character(RaceByLength))))))) %>%
  mutate(Sex = ifelse(Sex == "Female", "F",
               ifelse(Sex == "Male", "M",
               ifelse(Sex == "Unknown", "U", NA)))) %>%
  mutate(FishTagID = str_replace_all(FishTagID, "2019Ad_Plus", "2019Ad_plus")) %>%
  mutate(MarkCode = ifelse(MarkCode == "none", "None",
                    ifelse(MarkCode == "n/p", NA, as.character(MarkCode)))) %>%
  mutate(SpawningCondition = 
        ifelse(SpawningCondition == "Expressing Eggs", "EGGS",
        ifelse(SpawningCondition == "Expressing Milt", "MILT",
               NA))) %>%
  mutate(StageCode = 
           ifelse(as.character(StageCode) == "CHN_S", "SMT",
          ifelse(as.character(StageCode) == "CHN_P", "PAR",
         ifelse(as.character(StageCode) == "CHN_X", "TRS",              ifelse(substring(FishTagID, 1L, 1L) == "A", "ADT",
        NA))))) %>%
    mutate(PlusCount = replace(PlusCount, is.na(ForkLength) & Count >1, TRUE),
      PlusCount = replace(PlusCount, !is.na(ForkLength) & Count == 1, FALSE)) %>% #identify plus counts if no measurements and count >1. If measurement included, plus count should be FALSE.
  filter(!is.na(SampleID)) # remove if no ID

# Make all consistent "minus"
fish_catch_clean$FishTagID <- gsub("minus", "min", fish_catch_clean$FishTagID)
fish_catch_clean$FishTagID <- gsub("min", "minus", fish_catch_clean$FishTagID)

# Checks of variable codes
unique(fish_catch_clean$MarkCode)
unique(fish_catch_clean$StageCode) ### Check if there are changes
unique(fish_catch_clean$SpawningCondition)
unique(fish_catch_clean$Sex)
unique(fish_catch_clean$RaceByLength)

# QA/QC further checks
FishTagIDs <- filter(fish_catch_clean, FishTagID != "")
noCount <- filter(fish_catch_clean, Count == 0 | is.na(Count) | Count == "") 
needRace <- filter(fish_catch_clean, is.na(RaceByLength) & OrganismCode == "CHN" & !is.na(ForkLength))
```

### Taxa
```{r}
# Taxa
fish_tax_clean <- fish_tax %>%
  select(c(2,4)) 

fish_tax_ed_clean <- fish_tax_ed %>%
  dplyr::rename(OrganismCode = OrganismCode_FISH)
```

### Seine and trap effort
```{r}
# Seine
seine_clean <- seine %>%
  select(c(1, 4:10, 11, 16)) %>%
  rename(SeineComments=Comments) %>%
  mutate(SubstrateCode =
           case_when(
             as.character(SubstrateCode) %in% c("Gravel", "grv", "GR", "mud and gr") ~
             "GRV",
             as.character(SubstrateCode) %in% c("Mud", "MD", "md", "mud") ~ "MUD",
             as.character(SubstrateCode) %in% c("PV", "Pavement") ~ "PAV",
             as.character(SubstrateCode) %in% c("Vegetation", "VG", "mud/veg")~"AVG",
             as.character(SubstrateCode) %in% c("Sand", "SN", "silt")~"SND",
             as.character(SubstrateCode) == "grass"~"TVG",
             TRUE ~ as.character(SubstrateCode))) 
unique(seine_clean$HabitatType) #good
unique(seine_clean$SubstrateCode) # good
unique(seine_clean$Region)

# Trap
trap_clean <- left_join(fish_ref_clean %>% select(StationCode, MethodCode,SampleDate, Datetime, SampleID),trap %>% select(SampleID, Comments, AL_datatatus)) %>%
  mutate(effort.hrs = NA) %>%
  rename(TrapComments = Comments) %>%
  select(StationCode, MethodCode,SampleDate, Datetime, SampleID, AL_datatatus, effort.hrs, TrapComments) %>%
  filter(SampleDate<as.Date("2010-01-01"),
         MethodCode %in% c("FKTR", "RSTR"))

# Effort
effort_clean <- effort %>%
  mutate(Datetime = lubridate::ymd_hms(Datetime),
         SampleDate = lubridate::ymd(SampleDate),
         MethodCode = factor(MethodCode),
         StationCode = factor(StationCode)) %>%
  rename(TrapComments = Comments)

# Combine trap effort (2010 - .) with other trap (prior to 2010) so you get trap status 
trapeffort_clean <- rbind(trap_clean, effort_clean)
unique(trap_clean$AL_datatatus)
```

### Genetics and CWT
```{r}
## genetics ##
smelt_gen_clean <- smelt_gen %>%
  select(-c("Active")) %>%
  dplyr::rename(GenotypeRun = Genotype.Run,
                GeneticID = SPECIES..Assay.ID.,
                qDS = q..DS.,
                qLFS = q..LF.,
                qWAG = q..WK.,
                NumChrom = X..Chroms,
                VShape = V.shape,
                SmeltComments = COMMENTS)%>%
  mutate(GeneticID = case_when(
    GeneticID == "hybrid (LFS/WAG)" ~ "HYB_LFS_WAG",
    GeneticID == "hybrid (DSM/WAG)" ~ "HYB_DSM_WAG",
    GeneticID == "missing data" ~ "UNK",
    TRUE ~ as.character(GeneticID)))

unique(smelt_gen_clean$GeneticID)
unique(smelt_gen_clean$VShape)



salm_gen_clean <- salm_gen %>%
  dplyr::rename(GeneticID = BestEstimate,
                GeneticID2 = X2ndBestEstimate,
                SalmComments = Comments)  %>%
  mutate(GeneticID = case_when(
    GeneticID %in% c("f", "F")~ "Fall",
    GeneticID == "S"~ "Spring",
    GeneticID == "LF"~ "LateFall",
    GeneticID == "W"~ "Winter",
    GeneticID %in% c("U", "")~ "n/p", 
    TRUE ~ as.character(GeneticID))) %>%
  mutate(GeneticID2 = case_when(
    GeneticID2 %in% c("f", "F")~ "Fall",
    GeneticID2 == "S"~ "Spring",
    GeneticID2 == "LF"~ "LateFall",
    GeneticID2 == "W"~ "Winter",
    GeneticID2 %in% c("U", "")~ "n/p", 
    TRUE ~ as.character(GeneticID2)))
unique(salm_gen_clean$GeneticID)

salm_gen_clean$FishTagID <- gsub("minus", "min", salm_gen_clean$FishTagID)
salm_gen_clean$FishTagID <- gsub("min", "minus", salm_gen_clean$FishTagID)

# CWT
cwt_clean <- cwt %>%
  select(-CWTRowID) %>%
  rename(CWTComments = Comments)
```

Genetics Code with Sarah

```{r}
smelt_gen_clean_newcol <- smelt_gen_clean
Prob1 <- c()
Prob2 <- c()
Prob3 <- c()

for(row in 1:nrow(smelt_gen_clean_newcol)) {
  realrow = smelt_gen_clean_newcol[row,]
  orderedq = with(realrow, sort(c(qDS, qLFS, qWAG)))
  Prob1 = append(Prob1, orderedq[1])
  Prob2 = append(Prob2, orderedq[2])
  Prob3 = append(Prob3, orderedq[3])
  GenID1 = ifelse(Prob)
  
#  vec = sort(c(smelt_gen_clean)
}
smelt_gen_clean_newcol[,"Prob1"] = Prob1
smelt_gen_clean_newcol[,"Prob2"] = Prob2
smelt_gen_clean_newcol[,"Prob3"] = Prob3

# for assigning names use casewhen

# Cat play
df = smelt_gen_clean
df$Prob1 <- do.call(`pmax`, df[,7:9])
df$Prob3 <- do.call(`pmin`, df[,7:9])
df <- df %>% 
  rowwise() %>%
  filter(!is.na(qDS)) %>%
  mutate(Prob1 = max(qDS,qLFS,qWAG),
         Prob3 = min(qDS,qLFS,qWAG),
         Prob2 = 1-Prob1-Prob3) %>%
  mutate(GeneticID3 = case_when(
    qLFS == min(qDS:qWAG) ~"LFS",
    qWAG == min(qDS:qWAG) ~"WAG",
    qDS == min(qDS:qWAG)~"DS"))
```

##3. Join sampling with effort and comments
Remove known incorrect IDs, replace with corrected dates from effort file
```{r}
#remove rows with comments that indicate the fyke was not set (copied over from effort file)
fykeNotSet_ids <- c(3192, 7118, 7641, 8050, 8051, 8361)
#sremove duplicated/mis-entered samples (copied over from effort file)
dataEntry_ids <- c(1698, 1858, 1862, 2009, 2477, 2826, 3485, 6971)

Sample_effort <- (fish_ref_clean %>% select(-SampleTime, -SampleDate)) %>%
  filter(!(SampleID %in% c(fykeNotSet_ids, dataEntry_ids))) %>%
  left_join(trapeffort_clean, by = c("StationCode", "SampleID", "MethodCode"))%>%
  mutate(Datetime = ifelse(is.na(Datetime.y), Datetime.x, Datetime.y)) %>%
  mutate(Datetime=as.POSIXct(Datetime, origin = "1970-01-01", tzone = "America/Los Angeles"),
         SampleDate = as.Date(Datetime)) %>%
  dplyr::select(-Datetime.x,  -Datetime.y, -Datetime.x, -Datetime.y)%>%
  dplyr::select(SampleID, Datetime, SampleDate, StationCode, MethodCode, everything())%>%
  filter(!is.na(SampleID),
         !is.na(Datetime)) %>%
  arrange(MethodCode)

```

##4. Join seine
```{r}
Sample_effort_seine <- Sample_effort %>%
  left_join(seine_clean) %>%
  mutate(GearConditionCode = ifelse(is.na(GearConditionCode) & !is.na(ConditionCode), ConditionCode, GearConditionCode)) %>%
  mutate_if(is.factor, empty_as_na) %>%
  mutate_if(is.character, empty_as_na) %>%
  mutate(FieldComments = 
        ifelse(MethodCode == "BSEIN", SeineComments,
        ifelse(MethodCode %in% c("RSTR","FKTR"), TrapComments, NA))) %>%
  select(-c(ConditionCode, TrapComments, SeineComments))
```

##5. Evaluate Comments Filter for comments
```{r}
SampleComments <- Sample_effort_seine %>% 
  select(c(SampleID, SampleDate, Datetime, StationCode, WaterTemperature, GearConditionCode, MethodCode,FieldComments, TrapStatus, GearConditionCode)) %>%
  filter(!(is.na(FieldComments))) %>%
  mutate(SampleChange = "")

write.csv(SampleComments, "SampleComments.csv")
```

Changes made to condition code
```{r}
shouldbe1 <- c(3980, 6027, 7159, 7724, 8055, 8283, 8751, 6129, 6130, 8068, 8067, 8436, 8551, 8562, 8448, 8624, 8628, 8629,8635,8652,
               # screw trap
               5933, 5934, 7444)
# missing or hyacinth related , fyke not in middle of channel
shouldbe4 <- c(4016, 4014, 4013, 4015, 4340, 4947, 5471, 5503, 5532, 8317, 6039, 6256, 6991)
shouldbe3 <- c(8282, 7564)# very poor condition
shouldbe2 <- c(1524, 1525,1401, 2680, 4228, 5948, 7587, 6865, 6109, 6849, 761, 762, 829, 835, 1086, 1113, 7561,
               #screw trap
               1401, 5279, 6540 )
# no seine (hyacinth, too shallow, too deep): 4016, 4014, 4013, 4015, 4340, 4947, 5471, 5503, 5532, 6039, 6849 (check), 6256 (tide is too high??), 6991 (check), 
# twisted bag: 5948, 7587
# flipped seine: 6109
# clogged cone/debris: 1401
# might have lost some catch: 2680
# fyke not set to full depth: 761, 762, 1113
# fish escape: 829, 835, 1086, 7561, 7564
```

Add flag for change to sample
```{r}
sampleChange <- c(096, 5093, 4844, 5493, 5510, 5859, 6038, 6077, 6104, 6436, 6517, 6590, 6589, 6617, 6654, 6677, 6988, 6989, 7133, 7159, 7167, 7535, 7724, 8209, 8227, 8243, 8290, 8283, 8751, 8058,8673, 2307, 4806, 6106,6116, 7116, 7141, 7258, 7591, 7682, 7695, 7883, 8055, 8151, 8474, 8494, 8622, 8673, 9014, 3438, 7409, 8160, 8440, 8448, 290, 3292, 3293, 3295, 6129, 6130, 7266, 8068, 8067, 8436, 8437, 8404, 8403, 8401, 8442, 7515, 8551, 8562, 8624, 8628, 8529, 8635, 8652, 8318, 8469, 8532, 8575, 8604, 7261, 4486, 7492, 8173, 8548, 9057, 8656, 3946, 4741)
# change in amount of time set/distance of seine: 5096, 5093, 4844, 5493, 5510, 5859, 6038, 6077, 6104, 6436, 6517, 6590, 6589, 6617, 6654, 6677, 6988, 6989, 7133, 7159, 7167, 7535, 7724, 8209, 8227, 8243, 8290, 8283, 8751, 8058

# change in location of set: 8673, 2307, 4806, 6106,6116, 7116, 7141, 7258, 7591, 7682, 7695, 7883, 8055, 8151, 8474, 8494, 8622, 8673, 9014, 3438, 7409, 8160, 8440, 8448

# Fyke not in center of channel: 3290, 3292, 3293, 3295, 6129, 6130, 7266, 8068, 8067, 8436, 8437, 8404, 8403, 8401, 8442, 7515, 8551, 8562, 8624, 8628, 8529, 8635, 8652

# moved around veg, changed width: 8318

# parallel: 8469, 8532, 8575, 8604, 7261, 4486, 7492, 8173, 8548, 9057, 8656

# screw trap not in center of toe drain: 3946, 4741

# Not adding these for now, since I think a lot are unmarked
# short set RSTR: 4103, 4101, 4099, 4436, 4441, 4443, 4445, 4449, 4452, 4453, 4454, 4456, 4460, 4479, 4502, 4508, 4514, 5620, 4528, 4539, 4541, 4542, 4544, 4536, 4558, 5086, 5099, 5097, 5093, 5094, 5090, 6865, 7358, 7360, 7364, 7376, 7420, 7423, 7424, 7427, 7444, 7465, 7464, 7467, 7480, 7503, 7504, 7509, 7525, 7543,7608,7567,7566,7609,7610,7603,7602,
```

Make changes
```{r}
Sample_effort_clean <- Sample_effort_seine %>%
  mutate(GearConditionCode = 
           case_when(SampleID %in% shouldbe4 ~ 4,
                     SampleID %in% shouldbe3 ~ 3,
                     SampleID %in% shouldbe2 ~ 2,
                     SampleID %in% shouldbe1 ~ 1,
                     TRUE ~ as.numeric(GearConditionCode))) %>%
  mutate(SampleChange = ifelse(SampleID %in% sampleChange, 1, 0))
```

##6. Check sample sizes
```{r}
# Check number of samples seems appropriate
# Plot datetimes 
AllSamples <- Sample_effort_clean %>%
  mutate(year = year(Datetime)) %>%
  group_by(year, StationCode) %>%
  summarize (n = n())

seines <- AllSamples %>%
  filter(!(StationCode %in% c("PCS", "STTD")),
         year != 1998)
AL_data <- filter(AllSamples, StationCode %in% c("PCS", "STTD"))

(seineSamples <- ggplot(seines) + geom_tile(aes(x = factor(year), y = StationCode, fill = n)) + scale_fill_viridis() + theme(axis.text.x = element_text(angle = 90)))
plotly::ggplotly(seineSamples)

ggplot(AL_data) + geom_tile(aes(x = factor(year), y = StationCode, fill = n)) + scale_fill_viridis()+ theme(axis.text.x = element_text(angle = 90))
```

##7. Evaluate Water Quality

```{r}
# Create regions for visualization -----------------------
AL <- c("AL1", "AL2", "AL3", "AL4", "LIS")
BL <- c("BL1", "BL2", "BL3", "BL4", "BL5", "BL6", "STTD", "PCS")
Other <- c("YB", "FW1", "SB1",  "RD22", "YBI80", "SB2", "LIHF", "LIHFS")

# Separate and clean WQ -------------------------------------
fish_WQ <- fish_ref_clean %>%
  left_join(SampleComments %>%select(SampleID, FieldComments)) %>%
  select(c(Datetime, StationCode, SampleID, MethodCode,FieldComments, WaterTemperature:Turbidity))%>%
  filter(!(is.na(Datetime)),
         !(is.na(StationCode)),
         !(StationCode %in% c("", "Alt_Fyke", "CCS1", "CCS2", "CCS3", "CCS4", "CCS5", "CCS6", "STB", "STS", "YBSP1"))) %>%
  mutate(Region = ifelse(StationCode %in% AL, "AL", ifelse(StationCode %in% BL, "BL", "Other"))) %>%
  mutate(Month = month(Datetime),
         Year = year(Datetime),
         MonthAbb=month(Datetime, label = TRUE))
```

Summarize parameters of data
```{r}
source("WQ_plots.R")
Table_WQ_All <- fish_WQ %>%
  group_by(Region) %>%
summarize(min.temp = min(WaterTemperature, na.rm=T),
            max.temp = max(WaterTemperature, na.rm=T),
            min.Conductivity = min(Conductivity, na.rm=T),
            max.Conductivity = max(Conductivity,na.rm=T),
            min.SPC = min(SpCnd,na.rm=T),
            max.SPC = max(SpCnd,na.rm=T),
            min.Secchi = min(Secchi,na.rm=T),
            max.Secchi = max(Secchi,na.rm=T),
            min.Turbidity = min(Turbidity,na.rm=T),
            max.Turbidity = max(Turbidity,na.rm=T),
            min.pH = min(pH,na.rm=T),
            max.pH = max(pH,na.rm=T),
            min.DO = min(DO,na.rm=T),
            max.DO = max(DO,na.rm=T),
            n = n()) 

kable(t(Table_WQ_All)) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Make data long
```{r}
fish_WQ_long <- pivot_longer(fish_WQ, cols = c(WaterTemperature:Turbidity),names_to = "Parameter", values_to = "Value") %>%
  mutate(Index = 1:nrow(.))
```

```{r}
# Regions ------------------------------------------
AL_data <- filter(fish_WQ_long, Region == "AL") %>% arrange(StationCode, Datetime)
BL_data <- filter(fish_WQ_long, Region == "BL") %>% arrange(StationCode, Datetime)
Other_data <- filter(fish_WQ_long, Region == "Other") %>% arrange(StationCode, Datetime)

# AL -------------------------------------------------
AL_plots <- AL_data %>%
  ggplot(aes(x= Datetime, y = Value, color = StationCode, text = paste("Index:", Index, "SampleID:", SampleID))) + geom_point(size = 0.5) +  facet_wrap(~Parameter, scales = "free")
ggplotly(AL_plots)

# pH 27313, 27306, 27292, 27299, 27271, 27465, 24758, 24751, 24709, 24737, 24702, 24723, 24716, 24730
# Secchi 28541
# Turbidity 56469, 56483, 56476, 42931, 56833
# DO 28264, 57454
# Cond 28542, 26862

# Individual index of outliers
AL_vis_outliers <- c(7313, 27306, 27292, 27299, 27271, 27465, 24758, 24751, 24709, 24737, 24702, 24723, 24716, 24730, 28541, 56469, 56483, 56476, 42931, 56833, 28264, 57454, 28542, 26862)


# BL ----------------------------------------------------
BL_plots <- BL_data %>%
  ggplot(aes(x= Datetime, y = Value, color = StationCode, text = paste("Index:", Index, "SampleID:", SampleID))) + geom_point(size = 0.5) +  facet_wrap(~Parameter, scales = "free")
ggplotly(BL_plots)

#delete: 2215, 7229, 7230, 7231, 19621
#flag: 
# temp 2696, 
# secchi 48043, 14044, 2935
# turbidity 45416, 3344,
# do 54997, 50748, 40640, 35439, 23917, 23903, 23896, 23910
# pH 27376, 61564
# spcnd 57824

BL_vis_outliers <- c(2696,8043, 14044, 2935, 45416, 3344,54997, 50748, 40640, 35439, 23917, 23903, 23896, 23910, 27376, 61564, 57824)

# Other --------------------------------------
Other_plots <- Other_data %>%
  ggplot(aes(x= Datetime, y = Value, color = StationCode, text = paste("Index:", Index, "SampleID:", SampleID))) + geom_point(size = 0.5) +  facet_wrap(~Parameter, scales = "free")
ggplotly(Other_plots)

# pH 39787, 27369, 28362
# Secchi 17341, 695
# Temp 2941, 2948, 3039
# Turbidity: 56812

Other_vis_outliers <- c(39787, 27369, 28362, 17341, 695, 2941, 2948, 3039, 56812)

# List of outliers ------------------------------------------
Index_vis_outlier <- c(7313, 27306, 27292, 27299, 27271, 27465, 24758, 24751, 24709, 24737, 24702, 24723, 24716, 24730, 28541, 56469, 56483, 56476, 42931, 56833, 28264, 57454, 28542, 26862, 39787, 27369, 28362, 17341, 695, 2941, 2948, 3039, 56812, 2696,8043, 14044, 2935, 45416, 3344,54997, 50748, 40640, 35439, 23917, 23903, 23896, 23910, 27376, 61564, 57824)

toremove <- c(2215, 7229, 7230, 7231, 19621)

```


### Calculate Tukey, MAD outliers, calculate rate of change
```{r}
library(ODWGtools)
Outliers0 <- fish_WQ_long %>%
  filter(!(Index %in% toremove)) %>%
  group_by(Region, StationCode, Parameter) %>%
  arrange(StationCode, Datetime, Parameter) %>%
  mutate(Tukey = outlier_tukey(Value, na.rm = TRUE),
         MAD = outlier_mad(Value, mask = !is.na(Value)),
         Tukey_num = ifelse(Tukey == "extreme outlier", 2L, ifelse(Tukey == "mild outlier", 1L, ifelse(Tukey == "not outlier", 0L, Tukey))),
         MAD_num = ifelse(MAD == "extreme outlier", 2L, ifelse(MAD == "mild outlier", 1L, ifelse(MAD == "not outlier", 0L, MAD))),
         Outlier_vis = ifelse(Index %in% Index_vis_outlier, 2L, 0L),
         Outlier = Tukey_num + MAD_num + Outlier_vis,
         lag = difftime(Datetime, lag(Datetime), units = "days"),
         RateLag = round(rpdlag(Value),2),
         RateLead = round(rpdlead(Value),2))%>%
  ungroup() 
```

What are the upper limits for rate of change? 
```{r}
RatesofChange <- Outliers0 %>%
  group_by(Region, Parameter) %>%
  filter(lag < 30) %>%
  summarize(meanRate = mean(RateLag, na.rm = TRUE),
            medianRate = abs(median(RateLag, na.rm = TRUE))) %>%
  ungroup() %>%
  group_by(Region, Parameter) %>%
  summarize(
      median = median(medianRate, na.rm = TRUE),
      Q3 = quantile(medianRate, 0.75, na.rm = TRUE),
        IQR = IQR(medianRate, na.rm = TRUE),
        UL = Q3 + 1.5*IQR) %>%
  arrange(Parameter) %>%
  ungroup()
 
```

Create rate of change outlier and additive flag
```{r}
Outliers <- Outliers0 %>%
  left_join(RatesofChange %>% select(Region, Parameter, UL)) %>%
  mutate(ROC_lead = ifelse(abs(RateLead) > abs(UL), 1L, 0L),
         ROC_lag = ifelse(abs(RateLag) > abs(UL), 1L, 0L),
         Outlier_ROC = ifelse(lag <30, ROC_lead + ROC_lag, NA),
         Flag = ifelse(Outlier > 4, 3, ifelse(Outlier >=3, 2, 1)))
```

Filter outliers
```{r}
AnyOutlier <- filter(Outliers, Flag > 1)
```

Plot Outliers
```{r}
# BL Sites
BL_outliers <- Outliers %>%
filter(Region == "BL") %>%
ggplot() + 
  geom_point(aes(Datetime, Value, colour = factor(Outlier), text = Index), size = 1) + 
  facet_wrap(~Parameter, scales = "free") + scale_colour_viridis(discrete = TRUE) + theme_bw() 

ggplotly(BL_outliers)

# AL Sites
Outliers %>%
filter(Region == "AL") %>%
ggplot() + 
  geom_point(aes(Datetime, Value, colour = factor(Outlier)), size = 1) + 
  facet_wrap(~Parameter, scales = "free") + scale_colour_viridis(discrete = TRUE) + theme_bw() 

# Other
Outliers %>%
filter(Region == "Other") %>%
ggplot() + 
  geom_point(aes(Datetime, Value, colour = factor(Flag)), size = 1) + 
  facet_wrap(~Parameter, scales = "free") + scale_colour_viridis(discrete = TRUE) + theme_bw()
```

```{r}
OutliersToCheck <- filter(Outliers, Outlier >=1)
```


Make plots to look for outliers
AL_data
```{r}
source("WQ_plots.R")
library(plotly)



# Water Temp-------------------------
Yearbox(AL_data, WaterTemperature)
Monthbox(AL_data,WaterTemperature)
VisPoint(AL_data,WaterTemperature)
VisHist(AL_data, WaterTemperature, 5)
dotchart(AL_data$WaterTemperature, labels = AL_data$Year)
  # Nothing of note

# Secchi-------------------------------
Yearbox(AL_data, Secchi)
Monthbox(AL_data,Secchi)
ggplotly(VisPoint(AL_data,Secchi))
VisHist(AL_data, Secchi, 0.1)
dotchart(AL_data$Secchi, labels = AL_data$Year)
hist(SecchiDiff$SecchiDiff2)  
  # Just one of note: 4732

# Turbidity----------------------------
Yearbox(AL_data, Turbidity)
Monthbox(AL_data,Turbidity)
ggplotly(VisPoint(AL_data,Turbidity))
VisHist(AL_data, Turbidity, 20)
dotchart(AL_data$Turbidity, labels = AL_data$Year)
checkTurb <- filter(AL_data, Turbidity > 600)
  # 8770, 8768, 8767, 8543, 6443

Yearbox(AL_data, DO)
Monthbox(AL_data,DO)
ggplotly(VisPoint(AL_data,DO))
VisHist(AL_data, DO, 1)
dotchart(AL_data$DO, labels = AL_data$Year)
  # 4289, 8601

Yearbox(AL_data, Conductivity)
Monthbox(AL_data,Conductivity)
ggplotly(VisPoint(AL_data,Conductivity))
VisHist(AL_data, Conductivity, 20)
dotchart(AL_data$Conductivity, labels = AL_data$Year)
  # Just one random point early on
  checkCond <- filter(AL_data, Year<2000 & !is.na(Conductivity))
# 4732, 3998
  
Yearbox(AL_data, SpCnd)
Monthbox(AL_data,SpCnd)
ggplotly(VisPoint(AL_data,SpCnd))
VisHist(AL_data, SpCnd, 20)
dotchart(AL_data$SpCnd, labels = AL_data$Year)
  # Looks fine

Yearbox(AL_data, pH)
Monthbox(AL_data,pH)
ggplotly(VisPoint(AL_data,pH))
VisHist(AL_data, pH, 1)
dotchart(AL_data$pH, labels = AL_data$Year)
  # Some high and low
  # 3973, 3974, 3975, 3976, 3977, 3830, 3823, 3831, 3829, 3841, 3839, 3837, 3838, 3824

# SampleIDs with outliers
#AL_vis_outliers <- c(3973, 3974, 3975, 3976, 3977, 3830, 3823, 3831, 3829, 3841, 3839, 3837, 3838, 3824, 4732, 3998, 4289, 8601, 770, 8768, 8767, 8543, 6443, 4732)



```





BL
```{r}
Yearbox(BL_data, WaterTemperature)
Monthbox(BL_data,WaterTemperature)
ggplotly(VisPoint(BL_data,WaterTemperature))
VisHist(BL_data, WaterTemperature, 5)
# 1210


Yearbox(BL_data, Secchi)
Monthbox(BL_data,Secchi)
ggplotly(VisPoint(BL_data,Secchi))
VisHist(BL_data, Secchi, 0.1)
# 7195, 2005, 1407

Yearbox(BL_data, Turbidity)
Monthbox(BL_data,Turbidity)
ggplotly(VisPoint(BL_data,Turbidity))
VisHist(BL_data, Turbidity, 20)
# 6811, 5074
# get rid of before 2010

Yearbox(BL_data, DO)
Monthbox(BL_data,DO)
ggplotly(VisPoint(BL_data,DO))
VisHist(BL_data, DO, 1)
# 1045, 1044, 3679, 3680, 5353, 6108, 8207, 7581
# get rid of before 2006

Yearbox(BL_data, Conductivity)
Monthbox(BL_data,Conductivity)
ggplotly(VisPoint(BL_data,Conductivity))
VisHist(BL_data, Conductivity, 20)
# get rid of random 1998 point

Yearbox(BL_data, SpCnd)
Monthbox(BL_data,SpCnd)
ggplotly(VisPoint(BL_data,SpCnd))
VisHist(BL_data, SpCnd, 20)
# 8655

Yearbox(BL_data, pH)
Monthbox(BL_data,pH)
ggplotly(VisPoint(BL_data,pH))
VisHist(BL_data, pH, 1)
# 4114, 9183


```

Correct issues, flag
```{r}

```

##9. Join catch and genetics, QC
```{r joinGenetics}
### Genetics
CatchGenetics <- left_join(fish_catch_clean, salm_gen_clean, by = "FishTagID")
CatchGenetics2 <- left_join(CatchGenetics, smelt_gen_clean, by = c("FishTagID", "GeneticID")) %>%
    mutate_each(funs(empty_as_na))

# QC Genetics
checkGen <- filter(CatchGenetics2, FishTagID !="" & GeneticSample == "TRUE") %>%
  arrange(OrganismCode)

# Salmon
checkGenSalm <- filter(checkGen, is.na(Prob1) & 
                         OrganismCode == "CHN" & 
                         !grepl("2020", FishTagID)  &
                         !grepl("min", FishTagID)) %>%
  arrange(FishTagID)

# Add 2019_ACHN_001
# Add 2017Ad_plus-F_02
# Add all 2019Ad_Plus-S
# Add all 2019Ad_Plus-W

# Smelt 
checkGenSmelt <- filter(checkGen, is.na(GeneticID) & 
                          OrganismCode %in% c("DSM", "LFS", "WAG") & 
                          !grepl("2020", FishTagID) & 
                          is.na(GeneticID)) %>% arrange(FishTagID)

# Add all of this in. I think some are missing. 

# Sent to Amanda
# write.csv(checkGenSalm, "R_write/SalmonMissing2.csv")
# write.csv(checkGenSmelt, "R_write/SmeltMissing2.csv")

```

##10. Join CWT, QC
```{r joinCWT}
CatchGenCWT <- left_join(CatchGenetics2, cwt_clean)

checkCWT <- filter(CatchGenCWT, 
                   OrganismCode == "CHN",
                   grepl("min", FishTagID),
                   is.na(CWT_TagCode),
                   !grepl("no tag", CWTComments),
                   !grepl("tag lost", CWTComments)) %>%
  select(-c(SalmGenRowID:GenotypeRun))

# Sent to Amanda missing CWT Tags
# write.csv(checkCWT, "R_write/MissingCWTTag.csv")

```

##11. Join with taxonomic info, QC
```{r joinTaxonomy}
CatchTaxon <- left_join(CatchGenCWT, fish_tax_ed_clean) 
checkTaxa <- filter(CatchTaxon, is.na(TaxonName))
```

##12. Station Number
```{r joinStation, message = FALSE, warning = FALSE}
StationNum <- left_join(Sample_effort_seine, staNum_clean) 

checkStationNum <- filter(StationNum, is.na(StationNumber))

# Deal with stations not on the list 

```

##13. Join all
```{r joinAll, warning = FALSE, message = FALSE}
# Join and calculate CPUE
alldata <- left_join(StationNum, CatchTaxon) %>%
  mutate(CPUE = ifelse(MethodCode == "BSEIN", Count/VolumeSeined, Count/effort.hrs)) 

```

## 14. CPUE Outlier Checks
```{r}

```

# 15. Checks
* Check missing dates, SampleIDs, plus counts
```{r}
# Check missing SampleIDs
Issues <- alldata %>%
  filter(is.na(OrganismID)) 
```

## 16. Remove rows, columns, criteria
* Remove set data
* Separate genetics, diet, CWT out
```{r}
# Resolve issues and select columns
alldata2 <- alldata %>%
  filter(!(is.na(SampleID)),
         !(is.na(Datetime)),
         !(is.na(OrganismCode)),
         !(is.na(Count))) %>%
   filter(GearConditionCode<4) %>%
  select(-c(Kingdom:Superfamily, SmeltGenRowID, SalmGenRowID,  Region, GearID, GeneticSample, GeneticID:CWTComments)) %>%
  select(c(SampleID, Datetime, SampleDate, StationCode, MethodCode:Turbidity, FieldComments, OrganismCode, TaxonName, CommonName, Count, effort.hrs, VolumeSeined,CPUE,  ForkLength:FishIDComments))%>%
  arrange(desc(MethodCode, Datetime, StationCode)) 
 

```

## 17. Rename variables IEP style
```{r}
finalFish <- alldata2 %>%
  rename(Date = SampleDate,
         Volume = VolumeSeined,
         SampleNumber = SampleID,
         Gear = MethodCode,
         WaterTemp = WaterTemperature,
         SpecificConductance = SpCnd,
         TrapEffort = effort.hrs)
```


## 18. Double check
```{r}
summaryFinal <- finalFish %>%
  mutate(year = year(Datetime),
         month = month(Datetime)) %>%
  group_by(year, month, StationCode, Gear) %>%
  summarize(n = length(unique(SampleNumber)),
            meanCPUE = mean(CPUE, na.rm = TRUE))

plotly::ggplotly(ggplot(summaryFinal) + 
  geom_tile(aes(x = year, y=factor(month), fill = n)) +
  facet_wrap(~Gear) +
  viridis::scale_fill_viridis())

ggplot(summaryFinal) + 
  geom_tile(aes(x = year, y=factor(month), fill = meanCPUE)) +
  facet_wrap(~Gear) +
  viridis::scale_fill_viridis()
```

#19. Make taxonomy table
```{r}

```

#20. Make stations table
```{r}

```

#21. Make genetics tables
```{r}

```

#22. Write files
```{r}
write.csv(finalFish, "R_write/Fish-data-prelim-1998-2021_v2.csv")
```


